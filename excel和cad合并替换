import os
import threading
import gc
import time
import tkinter as tk
import tkinter.ttk as ttk
from tkinter import filedialog, scrolledtext, messagebox
import xlwings as xw
import win32com.client
import sys
import pythoncom  # <-- ç”¨äºçº¿ç¨‹çº§ COM åˆå§‹åŒ–/ååˆå§‹åŒ–

# ----------------- æ—¥å¿—ç»Ÿä¸€è¾“å‡º -----------------
class RedirectText:
    def __init__(self, text_widget):
        self.output = text_widget

    def write(self, string):
        self.output.insert(tk.END, string)
        self.output.see(tk.END)
        self.output.update()

    def flush(self):
        pass


def log(message):
    log_text.insert(tk.END, message + "\n")
    log_text.yview(tk.END)
    log_text.update()


# ----------------- Excel æ›¿æ¢å‡½æ•°ï¼ˆè¯¦ç»†æ—¥å¿—ç‰ˆï¼‰ -----------------
def replace_excel_text(folder_path, old_texts, new_texts, include_subfolders=False):
    log("âœ… å¼€å§‹å¤„ç† Excel æ–‡ä»¶...")
    app = None
    try:
        app = xw.App(visible=False)

        if include_subfolders:
            files = [os.path.join(root, f) for root, _, filenames in os.walk(folder_path)
                     for f in filenames if f.lower().endswith((".xls", ".xlsx")) and not f.startswith('~$')]
        else:
            files = [os.path.join(folder_path, f) for f in os.listdir(folder_path)
                     if f.lower().endswith((".xls", ".xlsx")) and not f.startswith('~$')]

        for file_path in files:
            log(f"\nâ¡ï¸ å¤„ç†ä¸­ï¼š{file_path}")
            wb = None
            try:
                wb = app.books.open(file_path, update_links=False)
                file_modified = False

                for sheet in wb.sheets:
                    try:
                        used_range = sheet.used_range
                        if used_range:
                            data = used_range.value
                            if data:
                                updated = False
                                if isinstance(data, list):
                                    for i in range(len(data)):
                                        row = data[i]
                                        if isinstance(row, list):
                                            for j in range(len(row)):
                                                cell = row[j]
                                                if isinstance(cell, str):
                                                    for old, new in zip(old_texts, new_texts):
                                                        if old and old in cell:
                                                            new_cell = cell.replace(old, new)
                                                            log(f"  ğŸ”„ {sheet.name}!{sheet.range((i+1,j+1)).address} : '{cell}' â†’ '{new_cell}'")
                                                            row[j] = new_cell
                                                            updated = True
                                    if updated:
                                        used_range.value = data
                                        file_modified = True
                                elif isinstance(data, str):
                                    for old, new in zip(old_texts, new_texts):
                                        if old and old in data:
                                            new_data = data.replace(old, new)
                                            log(f"  ğŸ”„ {sheet.name}!{used_range.address} : '{data}' â†’ '{new_data}'")
                                            used_range.value = new_data
                                            file_modified = True
                    except Exception as e:
                        log(f"âš ï¸ å•å…ƒæ ¼å¤„ç†å¼‚å¸¸: {str(e)[:50]}")

                    # é¡µçœ‰é¡µè„šå¤„ç†
                    try:
                        ps = sheet.api.PageSetup
                        for attr in ["LeftHeader", "CenterHeader", "RightHeader",
                                     "LeftFooter", "CenterFooter", "RightFooter"]:
                            val = getattr(ps, attr)
                            if val:
                                for old, new in zip(old_texts, new_texts):
                                    if old and old in val:
                                        new_val = val.replace(old, new)
                                        setattr(ps, attr, new_val)
                                        file_modified = True
                                        log(f"  ğŸ”„ {sheet.name} {attr} : '{val}' â†’ '{new_val}'")
                    except Exception as e:
                        log(f"âš ï¸ é¡µçœ‰é¡µè„šå¤„ç†å¼‚å¸¸: {str(e)[:50]}")

                if file_modified:
                    wb.save()
                    log(f"  ğŸ’¾ å·²ä¿å­˜: {os.path.basename(file_path)}")
                else:
                    log(f"  â­ï¸ æœªä¿®æ”¹: {os.path.basename(file_path)}")
            except Exception as e:
                log(f"âŒ æ–‡ä»¶å¤„ç†å¤±è´¥: {os.path.basename(file_path)}\n    {str(e)[:100]}")
            finally:
                if wb:
                    wb.close()
                    gc.collect()

        log("ğŸ‰ Excel æ–‡ä»¶å¤„ç†å®Œæˆï¼")
    except Exception as e:
        log(f"âŒ Excel è‡´å‘½é”™è¯¯: {str(e)}")
    finally:
        if app:
            app.quit()
            gc.collect()
            log("âœ… Excel èµ„æºå·²é‡Šæ”¾")


# ----------------- æ›´ç¨³å¥çš„ CAD æ›¿æ¢å®ç° -----------------
def _get_text_prop(entity):
    """
    è¿”å›å®ä½“ä¸Šç¬¬ä¸€ä¸ªå¯è¯»çš„æ–‡å­—å±æ€§åä¸å€¼ï¼›å…¼å®¹ä¸åŒ AutoCAD ç‰ˆæœ¬çš„å±æ€§åã€‚
    """
    for prop in ("TextString", "Text", "Contents"):
        try:
            val = getattr(entity, prop)
            if val is not None:
                return prop, val
        except Exception:
            continue
    return None, None


def _set_text_prop(entity, prop, value):
    """
    å°è¯•è®¾ç½®å®ä½“çš„æ–‡å­—å±æ€§ï¼Œè¿”å›æ˜¯å¦æˆåŠŸã€‚
    """
    try:
        setattr(entity, prop, value)
        return True
    except Exception:
        return False


def replace_text_in_dwg(dwg_path, old_texts, new_texts, acad, max_retries=3):
    """
    æ‰“å¼€ dwg å¹¶æ›¿æ¢æ–‡å­—ã€‚å‡ºç°å¯æ¢å¤æ€§é”™è¯¯æ—¶é‡è¯•ï¼ˆé‡å¼€æ–‡æ¡£ï¼‰ã€‚
    """
    attempt = 0
    while attempt < max_retries:
        attempt += 1
        doc = None
        try:
            log(f"\nâ¡ï¸ å¤„ç†æ–‡ä»¶: {dwg_path} ï¼ˆå°è¯• {attempt}/{max_retries}ï¼‰")
            doc = acad.Documents.Open(dwg_path)

            # æ ¹æ®æ–‡ä»¶å¤§å°é€‚å½“ç­‰å¾…ï¼Œç»™ AutoCAD åˆå§‹åŒ–/æ¸²æŸ“ä¸€ç‚¹æ—¶é—´
            file_size_mb = os.path.getsize(dwg_path) / (1024 * 1024)
            delay_time = 0.8 + min(file_size_mb / 8, 2)
            time.sleep(delay_time)

            try:
                doc.Application.ZoomExtents()
                time.sleep(0.2)
            except Exception:
                pass

            # å°è¯•è®¿é—® ModelSpace ä¸ PaperSpace
            spaces = []
            try:
                spaces.append(("ModelSpace", doc.ModelSpace))
            except Exception:
                log("  âš ï¸ æ— æ³•è®¿é—® ModelSpaceã€‚")
            try:
                # PaperSpace æœ‰æ—¶ä¸å¯ç”¨æˆ–å« Layoutsï¼Œä½† doc.PaperSpace åœ¨å¤šæ•°æƒ…å†µä¸‹å¯ç”¨
                spaces.append(("PaperSpace", doc.PaperSpace))
            except Exception:
                pass  # å¿½ç•¥

            if not spaces:
                log("  âŒ æœªæ‰¾åˆ°å¯ç”¨ç©ºé—´ï¼ˆModelSpace/PaperSpaceï¼‰ã€‚")
                if doc:
                    try:
                        doc.Close(False)
                    except Exception:
                        pass
                return

            changed = 0

            for space_name, space in spaces:
                try:
                    for entity in space:
                        try:
                            # æ™®é€šæ–‡å­— / å¤šè¡Œæ–‡å­—
                            prop_name, text_val = _get_text_prop(entity)
                            if prop_name and isinstance(text_val, str):
                                new_val = text_val
                                for old, new in zip(old_texts, new_texts):
                                    if old and old in new_val:
                                        new_val = new_val.replace(old, new)
                                if new_val != text_val:
                                    ok = _set_text_prop(entity, prop_name, new_val)
                                    if ok:
                                        changed += 1
                                        log(f"  ğŸ”„ [{space_name}] {entity.ObjectName} æ›¿æ¢: '{text_val}' -> '{new_val}'")
                                    else:
                                        log(f"  âš ï¸ æ— æ³•è®¾ç½®å±æ€§ {prop_name} äºå®ä½“ {entity.ObjectName}")

                            # å¤„ç†å—å¼•ç”¨åŠå…¶å±æ€§
                            if entity.ObjectName == "AcDbBlockReference":
                                try:
                                    if getattr(entity, "HasAttributes", False):
                                        for attr in entity.GetAttributes():
                                            try:
                                                prop_name_attr, text_val_attr = _get_text_prop(attr)
                                                if prop_name_attr and isinstance(text_val_attr, str):
                                                    new_val_attr = text_val_attr
                                                    for old, new in zip(old_texts, new_texts):
                                                        if old and old in new_val_attr:
                                                            new_val_attr = new_val_attr.replace(old, new)
                                                    if new_val_attr != text_val_attr:
                                                        ok_attr = _set_text_prop(attr, prop_name_attr, new_val_attr)
                                                        try:
                                                            attr.Update()
                                                        except Exception:
                                                            pass
                                                        if ok_attr:
                                                            changed += 1
                                                            log(f"  ğŸ”„ [{space_name}] å—å±æ€§æ›¿æ¢: '{text_val_attr}' -> '{new_val_attr}'")
                                            except Exception as e_attr:
                                                log(f"    âš ï¸ å—å±æ€§å¼‚å¸¸: {str(e_attr)[:120]}")
                                except Exception:
                                    pass

                        except Exception as e_entity:
                            log(f"    âš ï¸ å®ä½“å¤„ç†å¼‚å¸¸: {str(e_entity)[:120]}")
                except Exception as e_space:
                    log(f"  âš ï¸ éå† {space_name} å¼‚å¸¸: {str(e_space)[:120]}")

            # å¼ºåˆ¶é‡ç»˜/åˆ·æ–°
            try:
                doc.Regen(0)  # 0 å¯¹åº” acActiveViewport
                time.sleep(0.15)
            except Exception:
                pass

            if changed > 0:
                try:
                    doc.Save()
                    log(f"  âœ… ä¿å­˜æˆåŠŸï¼Œå…±æ›¿æ¢ {changed} é¡¹ã€‚")
                except Exception as e_save:
                    log(f"  âŒ ä¿å­˜å¤±è´¥: {str(e_save)[:120]}")
                    # ä¿å­˜å¤±è´¥å°è¯•é‡è¯•
                    try:
                        doc.Close(False)
                    except Exception:
                        pass
                    if attempt < max_retries:
                        time.sleep(0.5)
                        continue
            else:
                log("  âš ï¸ æœªæ‰¾åˆ°åŒ¹é…é¡¹ã€‚")

            try:
                doc.Close(False)
            except Exception:
                pass

            gc.collect()
            time.sleep(0.1)
            break  # æˆåŠŸæˆ–æ— åŒ¹é…ï¼Œè·³å‡ºé‡è¯•å¾ªç¯

        except Exception as e:
            log(f"âŒ é”™è¯¯å¤„ç†æ–‡ä»¶ {dwg_path}: {str(e)[:300]}")
            # å°è¯•å…³é—­å¹¶é‡è¯•
            try:
                if doc:
                    doc.Close(False)
            except Exception:
                pass
            gc.collect()
            if attempt < max_retries:
                wait = 0.6 + attempt * 0.5
                log(f"   â³ ç­‰å¾… {wait:.1f}s åé‡è¯•...")
                time.sleep(wait)
                continue
            else:
                log("   âŒ è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œè·³è¿‡æ­¤æ–‡ä»¶ã€‚")
                break


def replace_cad_text(folder, old_texts, new_texts, include_subfolders=False, use_dispatchex=True):
    if include_subfolders:
        dwg_files = [os.path.join(root, f) for root, _, files in os.walk(folder)
                     for f in files if f.lower().endswith(".dwg") and not f.startswith('~$')]
    else:
        dwg_files = [os.path.join(folder, f) for f in os.listdir(folder)
                     if f.lower().endswith(".dwg") and not f.startswith('~$')]

    if not dwg_files:
        log("âš ï¸ æœªæ‰¾åˆ° DWG æ–‡ä»¶")
        return

    try:
        log("ğŸš€ å¯åŠ¨ AutoCAD ä¸­...")
        # ä¼˜å…ˆå°è¯• DispatchExï¼ˆåˆ›å»ºç‹¬ç«‹ COM å®ä¾‹ï¼‰ï¼Œå¤±è´¥åˆ™å›é€€ Dispatch
        if use_dispatchex:
            try:
                acad = win32com.client.DispatchEx("AutoCAD.Application")
            except Exception:
                acad = win32com.client.Dispatch("AutoCAD.Application")
        else:
            acad = win32com.client.Dispatch("AutoCAD.Application")

        acad.Visible = False
        # ç»™ AutoCAD ä¸€ç‚¹æ—¶é—´å¯åŠ¨
        time.sleep(1.2)

        for dwg_path in dwg_files:
            replace_text_in_dwg(dwg_path, old_texts, new_texts, acad, max_retries=3)

        log(f"\nâœ… æ‰€æœ‰ DWG æ–‡ä»¶å¤„ç†å®Œæˆï¼Œå…±å¤„ç† {len(dwg_files)} ä¸ªæ–‡ä»¶ã€‚")
    except Exception as e:
        log(f"âŒ AutoCAD å¯åŠ¨å¤±è´¥: {str(e)}")


# ----------------- å¯åŠ¨æ›¿æ¢çº¿ç¨‹ï¼ˆæ–¹æ¡ˆ Aï¼šçº¿ç¨‹å…¥å£åˆå§‹åŒ– COMï¼‰ -----------------
def start_replacement():
    folder = folder_entry.get()
    old_texts = [e.get() for e in old_entries]
    new_texts = [e.get() for e in new_entries]
    include_subfolders = process_subfolders_var.get()

    log_text.delete(1.0, tk.END)

    if not folder or not os.path.isdir(folder):
        messagebox.showerror("é”™è¯¯", "è¯·é€‰æ‹©æœ‰æ•ˆçš„æ–‡ä»¶å¤¹")
        return
    if not any(old_texts) or not any(new_texts):
        messagebox.showerror("é”™è¯¯", "è¯·è¾“å…¥è‡³å°‘ä¸€å¯¹æ›¿æ¢æ–‡å­—")
        return

    def task():
        # åœ¨æ­¤çº¿ç¨‹ä¸Šåˆå§‹åŒ– COMï¼ˆå¿…è¦ï¼‰
        pythoncom.CoInitialize()
        try:
            if excel_var.get():
                replace_excel_text(folder, old_texts, new_texts, include_subfolders)
            if cad_var.get():
                replace_cad_text(folder, old_texts, new_texts, include_subfolders, use_dispatchex=True)
        finally:
            # ç¡®ä¿ååˆå§‹åŒ– COMï¼Œé‡Šæ”¾çº¿ç¨‹ç»‘å®šèµ„æº
            try:
                pythoncom.CoUninitialize()
            except Exception:
                pass

    threading.Thread(target=task, daemon=True).start()


# ----------------- GUI ç•Œé¢ -----------------
root = tk.Tk()
root.title("æ‰¹é‡æ›¿æ¢ Excel å’Œ CAD æ–‡ä»¶æ–‡å­—")
root.geometry("800x720")
root.resizable(False, False)

# æ–‡ä»¶å¤¹é€‰æ‹©
tk.Label(root, text="é€‰æ‹©æ–‡ä»¶å¤¹ï¼š").grid(row=0, column=0, sticky="e", padx=10, pady=10)
folder_entry = tk.Entry(root, width=72)
folder_entry.grid(row=0, column=1, padx=5)

def select_folder():
    folder = filedialog.askdirectory()
    if folder:
        folder_entry.delete(0, tk.END)
        folder_entry.insert(0, folder)

tk.Button(root, text="æµè§ˆ...", command=select_folder).grid(row=0, column=2, padx=5)

# æ›¿æ¢æ–‡å­—è¾“å…¥
old_entries, new_entries = [], []
frame = tk.LabelFrame(root, text="æ‰¹é‡æ›¿æ¢æ–‡å­—ï¼ˆæœ€å¤š5ç»„ï¼‰", padx=10, pady=10)
frame.grid(row=1, column=0, columnspan=3, padx=10, pady=10, sticky="ew")

for i in range(5):
    row_index = i * 2
    tk.Label(frame, text=f"æ—§æ–‡å­— {i+1}:").grid(row=row_index, column=0, sticky="e", pady=4)
    old_entry = tk.Entry(frame, width=40)
    old_entry.grid(row=row_index, column=1, pady=4, padx=(0, 50))
    old_entries.append(old_entry)

    tk.Label(frame, text=f"æ–°æ–‡å­— {i+1}:").grid(row=row_index, column=2, sticky="e", pady=4)
    new_entry = tk.Entry(frame, width=40)
    new_entry.grid(row=row_index, column=3, pady=4, padx=5)
    new_entries.append(new_entry)

    if i < 4:
        ttk.Separator(frame, orient='horizontal').grid(row=row_index+1, column=0, columnspan=4, sticky="ew", pady=5)

# å‹¾é€‰æ¡†åŒºåŸŸ
excel_var = tk.BooleanVar(value=True)
cad_var = tk.BooleanVar(value=True)
process_subfolders_var = tk.BooleanVar(value=False)

options_frame = tk.Frame(root)
options_frame.grid(row=2, column=1, pady=5)

tk.Checkbutton(options_frame, text="å¤„ç† Excel æ–‡ä»¶", variable=excel_var).pack(side="left", padx=10)
tk.Checkbutton(options_frame, text="å¤„ç† CAD æ–‡ä»¶", variable=cad_var).pack(side="left", padx=10)
tk.Checkbutton(options_frame, text="å¤„ç†å­æ–‡ä»¶å¤¹", variable=process_subfolders_var).pack(side="left", padx=10)

# å¼€å§‹æŒ‰é’®
tk.Button(root, text="å¼€å§‹æ›¿æ¢", width=20, height=2, bg="#4CAF50", fg="white", command=start_replacement).grid(row=3, column=1, pady=15)

# æ—¥å¿—æ¡†
log_text = scrolledtext.ScrolledText(root, width=107, height=20)
log_text.grid(row=4, column=0, columnspan=3, padx=10, pady=10)

# é‡å®šå‘ stdout/stderr
sys.stdout = RedirectText(log_text)
sys.stderr = RedirectText(log_text)

root.mainloop()
