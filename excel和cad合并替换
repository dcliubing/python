import tkinter as tk
from tkinter import filedialog, messagebox, scrolledtext
import threading
import sys
import os
import win32com.client
import xlwings as xw

class RedirectText:
    def __init__(self, text_widget):
        self.output = text_widget

    def write(self, string):
        self.output.insert(tk.END, string)
        self.output.see(tk.END)

    def flush(self):
        pass

def browse_folder():
    folder = filedialog.askdirectory(title="é€‰æ‹©è¦å¤„ç†çš„æ–‡ä»¶å¤¹")
    if folder:
        folder_entry.delete(0, tk.END)
        folder_entry.insert(0, folder)

def start_replacement():
    folder = folder_entry.get()
    old_text = old_text_entry.get()
    new_text = new_text_entry.get()
    do_excel = excel_var.get()
    do_cad = cad_var.get()

    log_text.delete(1.0, tk.END)

    if not folder or not os.path.isdir(folder):
        messagebox.showerror("é”™è¯¯", "è¯·é€‰æ‹©æœ‰æ•ˆçš„æ–‡ä»¶å¤¹ã€‚")
        return
    if not old_text or not new_text:
        messagebox.showerror("é”™è¯¯", "è¯·å¡«å†™è¦æ›¿æ¢çš„æ–‡å­—ã€‚")
        return
    if not (do_excel or do_cad):
        messagebox.showwarning("æç¤º", "è¯·è‡³å°‘é€‰æ‹©ä¸€ç§è¦æ›¿æ¢çš„æ–‡ä»¶ç±»å‹ã€‚")
        return

    threading.Thread(
        target=lambda: run_tasks(folder, old_text, new_text, do_excel, do_cad),
        daemon=True
    ).start()

def run_tasks(folder, old, new, excel, cad):
    print("\nğŸš€ å¼€å§‹å¤„ç†...")
    files = os.listdir(folder)

    if excel:
        for f in files:
            if f.startswith('~') or f.startswith('~$'):
                continue
            if f.lower().endswith(('.xls', '.xlsx')):
                try:
                    path = os.path.join(folder, f)
                    print(f"â¡ï¸ Excel: {f}")
                    app = xw.App(visible=False)
                    wb = app.books.open(path)
                    for sheet in wb.sheets:
                        data = sheet.used_range.options(ndim=2).value
                        if data:
                            changed = False
                            for r, row in enumerate(data):
                                for c, val in enumerate(row):
                                    if isinstance(val, str) and old in val:
                                        data[r][c] = val.replace(old, new)
                                        changed = True
                            if changed:
                                sheet.used_range.options(ndim=2).value = data
                    wb.save()
                    wb.close()
                    app.quit()
                    print("  âœ… å®Œæˆ")
                except Exception as e:
                    print(f"  âŒ é”™è¯¯: {e}")

    if cad:
        try:
            acad = win32com.client.Dispatch("AutoCAD.Application")
            acad.Visible = False
            for f in files:
                if f.startswith('~') or f.startswith('~$'):
                    continue
                if f.lower().endswith(".dwg"):
                    try:
                        path = os.path.join(folder, f)
                        print(f"â¡ï¸ CAD: {f}")
                        doc = acad.Documents.Open(str(path))
                        ms = doc.ModelSpace
                        changed = 0
                        for entity in ms:
                            if entity.ObjectName == "AcDbText" and old in entity.TextString:
                                entity.TextString = entity.TextString.replace(old, new)
                                changed += 1
                            elif entity.ObjectName == "AcDbMText" and old in entity.TextString:
                                entity.TextString = entity.TextString.replace(old, new)
                                changed += 1
                            elif entity.ObjectName == "AcDbBlockReference" and hasattr(entity, 'HasAttributes') and entity.HasAttributes:
                                for attr in entity.GetAttributes():
                                    if old in attr.TextString:
                                        attr.TextString = attr.TextString.replace(old, new)
                                        changed += 1
                        if changed:
                            doc.Save()
                            print(f"  âœ… æ›¿æ¢ {changed} å¤„")
                        else:
                            print("  âš ï¸ æœªæ‰¾åˆ°åŒ¹é…")
                        doc.Close()
                    except Exception as e:
                        print(f"  âŒ é”™è¯¯: {e}")
        except Exception as e:
            print(f"âŒ å¯åŠ¨ AutoCAD å¤±è´¥: {e}")

    print("\nâœ… æ‰€æœ‰ä»»åŠ¡å®Œæˆã€‚")

# ----------------- GUI ---------------------
root = tk.Tk()
root.title("æ‰¹é‡æ›¿æ¢å·¥å…·ï¼ˆExcel / CADï¼‰")
root.geometry("720x480")
root.resizable(False, False)

tk.Label(root, text="é€‰æ‹©æ–‡ä»¶å¤¹ï¼š").grid(row=0, column=0, sticky="e", padx=10, pady=10)
folder_entry = tk.Entry(root, width=60)
folder_entry.grid(row=0, column=1, padx=5)
tk.Button(root, text="æµè§ˆ...", command=browse_folder).grid(row=0, column=2, padx=5)

tk.Label(root, text="åŸæ–‡å­—ï¼š").grid(row=1, column=0, sticky="e", padx=10, pady=10)
old_text_entry = tk.Entry(root, width=60)
old_text_entry.grid(row=1, column=1, columnspan=2, padx=5)

tk.Label(root, text="æ›¿æ¢ä¸ºï¼š").grid(row=2, column=0, sticky="e", padx=10, pady=10)
new_text_entry = tk.Entry(root, width=60)
new_text_entry.grid(row=2, column=1, columnspan=2, padx=5)

excel_var = tk.BooleanVar(value=True)
cad_var = tk.BooleanVar(value=True)

type_frame = tk.LabelFrame(root, text="æ›¿æ¢æ–‡ä»¶ç±»å‹")
type_frame.grid(row=3, column=0, columnspan=3, padx=20, pady=10, sticky="w")
tk.Checkbutton(type_frame, text="Excel (.xls/.xlsx)", variable=excel_var).pack(side="left", padx=10, pady=5)
tk.Checkbutton(type_frame, text="CAD (.dwg)", variable=cad_var).pack(side="left", padx=10, pady=5)

tk.Button(root, text="å¼€å§‹æ›¿æ¢", width=20, height=2, bg="#4CAF50", fg="white", command=start_replacement)\
    .grid(row=4, column=1, pady=10)

log_text = scrolledtext.ScrolledText(root, width=100, height=15, font=("Consolas", 10))
log_text.grid(row=5, column=0, columnspan=3, padx=10, pady=10)

sys.stdout = RedirectText(log_text)
sys.stderr = RedirectText(log_text)

root.mainloop()
