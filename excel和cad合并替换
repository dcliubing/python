import os
import threading
import gc
import time
import tkinter as tk
from tkinter import filedialog, scrolledtext, messagebox
from tkinter import ttk
import sys

# Excel 用到的库
import xlwings as xw
# CAD 用到的库
import win32com.client

# ----------------- 日志统一输出 -----------------
class RedirectText:
    def __init__(self, text_widget):
        self.output = text_widget

    def write(self, string):
        self.output.insert(tk.END, string)
        self.output.see(tk.END)
        self.output.update()

    def flush(self):
        pass


def log(message):
    log_text.insert(tk.END, message + "\n")
    log_text.yview(tk.END)

# ----------------- Excel 替换函数 -----------------
def replace_excel_text(folder_path, old_text, new_text):
    log("✅ 开始处理 Excel 文件...")
    app = None
    try:
        app = xw.App(visible=False)
        files = [os.path.join(root, f) for root, _, filenames in os.walk(folder_path)
                 for f in filenames if f.lower().endswith((".xls", ".xlsx")) and not f.startswith('~$')]

        for file_path in files:
            log(f"🔄 处理中：{file_path}")
            wb = None
            try:
                wb = app.books.open(file_path, update_links=False)
                file_modified = False

                for sheet in wb.sheets:
                    try:
                        used_range = sheet.used_range
                        if used_range:
                            data = used_range.value
                            if data:
                                updated = False
                                if isinstance(data, list):
                                    for i in range(len(data)):
                                        row = data[i]
                                        if isinstance(row, list):
                                            for j in range(len(row)):
                                                cell = row[j]
                                                if isinstance(cell, str) and old_text in cell:
                                                    row[j] = cell.replace(old_text, new_text)
                                                    updated = True
                                    if updated:
                                        used_range.value = data
                                        file_modified = True
                                elif isinstance(data, str) and old_text in data:
                                    used_range.value = data.replace(old_text, new_text)
                                    file_modified = True
                    except Exception as e:
                        log(f"⚠️ 单元格处理异常: {str(e)[:50]}")

                    try:
                        ps = sheet.api.PageSetup
                        for attr in ["LeftHeader", "CenterHeader", "RightHeader",
                                     "LeftFooter", "CenterFooter", "RightFooter"]:
                            val = getattr(ps, attr)
                            if val and old_text in val:
                                setattr(ps, attr, val.replace(old_text, new_text))
                                file_modified = True
                    except Exception as e:
                        log(f"⚠️ 页眉页脚处理异常: {str(e)[:50]}")

                if file_modified:
                    wb.save()
                    log(f"💾 已保存: {os.path.basename(file_path)}")
                else:
                    log(f"⏭️ 未修改: {os.path.basename(file_path)}")
            except Exception as e:
                log(f"❌ 文件处理失败: {os.path.basename(file_path)}\n    {str(e)[:100]}")
            finally:
                if wb:
                    wb.close()
                    gc.collect()

        log("🎉 Excel 文件处理完成！")
    except Exception as e:
        log(f"❌ Excel 致命错误: {str(e)}")
    finally:
        if app:
            app.quit()
            gc.collect()
            log("✅ Excel 资源已释放")

# ----------------- CAD 替换函数 -----------------
def replace_text_in_dwg(dwg_path, old_text, new_text, acad):
    try:
        print(f"\n➡️ 处理文件: {dwg_path}")
        doc = acad.Documents.Open(dwg_path)
        time.sleep(0.5)

        try:
            ms = doc.ModelSpace
        except Exception:
            print("  ❌ 文件没有 ModelSpace，可能损坏或非标准 DWG。")
            doc.Close(False)
            return

        changed = 0
        for entity in ms:
            try:
                if entity.ObjectName == "AcDbText" and old_text in entity.TextString:
                    entity.TextString = entity.TextString.replace(old_text, new_text)
                    print(f"  🔄 TEXT 替换: {old_text} -> {new_text}")
                    changed += 1
                elif entity.ObjectName == "AcDbMText" and old_text in entity.TextString:
                    entity.TextString = entity.TextString.replace(old_text, new_text)
                    print(f"  🔄 MTEXT 替换: {old_text} -> {new_text}")
                    changed += 1
                elif entity.ObjectName == "AcDbBlockReference":
                    if entity.HasAttributes:
                        for attr in entity.GetAttributes():
                            if old_text in attr.TextString:
                                attr.TextString = attr.TextString.replace(old_text, new_text)
                                attr.Update()
                                changed += 1
                                print(f"  🔄 块属性文字替换完成")
            except Exception as e_entity:
                print(f"    ⚠️ 实体处理异常: {e_entity}")

        if changed > 0:
            doc.Save()
            print(f"  ✅ 保存成功，共替换 {changed} 项。")
        else:
            print("  ⚠️ 未找到匹配项。")

        doc.Close(False)
    except Exception as e:
        print(f"❌ 错误处理文件 {dwg_path}: {e}")


def replace_cad_text(folder, old_text, new_text):
    dwg_files = [os.path.join(folder, f) for f in os.listdir(folder) if f.lower().endswith(".dwg")]
    if not dwg_files:
        log("⚠️ 未找到 DWG 文件")
        return

    try:
        print("🚀 启动 AutoCAD 中...")
        acad = win32com.client.Dispatch("AutoCAD.Application")
        acad.Visible = False
        time.sleep(1)

        for dwg_path in dwg_files:
            replace_text_in_dwg(dwg_path, old_text, new_text, acad)

        print(f"\n✅ 所有 DWG 文件处理完成，共处理 {len(dwg_files)} 个文件。")
        messagebox.showinfo("完成", f"DWG 文件处理完成！共处理 {len(dwg_files)} 个文件。")
    except Exception as e:
        messagebox.showerror("AutoCAD 启动失败", str(e))

# ----------------- 启动替换线程 -----------------
def start_replacement():
    folder = folder_entry.get()
    old_text = old_text_entry.get()
    new_text = new_text_entry.get()
    log_text.delete(1.0, tk.END)

    if not folder or not os.path.isdir(folder):
        messagebox.showerror("错误", "请选择有效的文件夹")
        return
    if not old_text or not new_text:
        messagebox.showerror("错误", "请输入要替换的文字")
        return

    def task():
        if excel_var.get():
            replace_excel_text(folder, old_text, new_text)
        if cad_var.get():
            replace_cad_text(folder, old_text, new_text)

    threading.Thread(target=task, daemon=True).start()

# ----------------- GUI 界面 -----------------
root = tk.Tk()
root.title("批量替换 Excel 和 CAD 文件文字")
root.geometry("750x600")
root.resizable(False, False)

# 选择文件夹
tk.Label(root, text="选择文件夹：").grid(row=0, column=0, sticky="e", padx=10, pady=10)
folder_entry = tk.Entry(root, width=50)
folder_entry.grid(row=0, column=1, padx=5)
tk.Button(root, text="浏览...", command=lambda: folder_entry.insert(0, filedialog.askdirectory())).grid(row=0, column=2, padx=5)

# 旧文字
tk.Label(root, text="要替换的旧文字：").grid(row=1, column=0, sticky="e", padx=10, pady=10)
old_text_entry = tk.Entry(root, width=50)
old_text_entry.grid(row=1, column=1, columnspan=2, padx=5)

# 新文字
tk.Label(root, text="替换为的新文字：").grid(row=2, column=0, sticky="e", padx=10, pady=10)
new_text_entry = tk.Entry(root, width=50)
new_text_entry.grid(row=2, column=1, columnspan=2, padx=5)

# 勾选框
excel_var = tk.BooleanVar(value=True)
cad_var = tk.BooleanVar(value=False)
tk.Checkbutton(root, text="处理 Excel 文件", variable=excel_var).grid(row=3, column=1, sticky="w", padx=20)
tk.Checkbutton(root, text="处理 CAD 文件", variable=cad_var).grid(row=3, column=1, sticky="e", padx=20)

# 开始按钮
tk.Button(root, text="开始替换", width=20, height=2, bg="#4CAF50", fg="white", command=start_replacement).grid(row=4, column=1, pady=15)

# 日志框
log_text = scrolledtext.ScrolledText(root, width=95, height=20)
log_text.grid(row=5, column=0, columnspan=3, padx=10, pady=10)

# 重定向 stdout/stderr
sys.stdout = RedirectText(log_text)
sys.stderr = RedirectText(log_text)

root.mainloop()
