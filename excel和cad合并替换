import os
import threading
import gc
import time
import tkinter as tk
import tkinter.ttk as ttk
from tkinter import filedialog, scrolledtext, messagebox
import xlwings as xw
import win32com.client
import sys

# ----------------- æ—¥å¿—ç»Ÿä¸€è¾“å‡º -----------------
class RedirectText:
    def __init__(self, text_widget):
        self.output = text_widget

    def write(self, string):
        self.output.insert(tk.END, string)
        self.output.see(tk.END)
        self.output.update()

    def flush(self):
        pass


def log(message):
    log_text.insert(tk.END, message + "\n")
    log_text.yview(tk.END)
    log_text.update()


# ----------------- Excel æ›¿æ¢å‡½æ•°ï¼ˆè¯¦ç»†æ—¥å¿—ç‰ˆï¼‰ -----------------
def replace_excel_text(folder_path, old_texts, new_texts):
    log("âœ… å¼€å§‹å¤„ç† Excel æ–‡ä»¶...")
    app = None
    try:
        app = xw.App(visible=False)
        files = [os.path.join(root, f) for root, _, filenames in os.walk(folder_path)
                 for f in filenames if f.lower().endswith((".xls", ".xlsx")) and not f.startswith('~$')]

        for file_path in files:
            log(f"\nâ¡ï¸ å¤„ç†ä¸­ï¼š{file_path}")
            wb = None
            try:
                wb = app.books.open(file_path, update_links=False)
                file_modified = False

                for sheet in wb.sheets:
                    try:
                        used_range = sheet.used_range
                        if used_range:
                            data = used_range.value
                            if data:
                                updated = False
                                if isinstance(data, list):
                                    for i in range(len(data)):
                                        row = data[i]
                                        if isinstance(row, list):
                                            for j in range(len(row)):
                                                cell = row[j]
                                                if isinstance(cell, str):
                                                    for old, new in zip(old_texts, new_texts):
                                                        if old and old in cell:
                                                            new_cell = cell.replace(old, new)
                                                            log(f"  ğŸ”„ {sheet.name}!{sheet.range((i+1,j+1)).address} : '{cell}' â†’ '{new_cell}'")
                                                            row[j] = new_cell
                                                            updated = True
                                    if updated:
                                        used_range.value = data
                                        file_modified = True
                                elif isinstance(data, str):
                                    for old, new in zip(old_texts, new_texts):
                                        if old and old in data:
                                            new_data = data.replace(old, new)
                                            log(f"  ğŸ”„ {sheet.name}!{used_range.address} : '{data}' â†’ '{new_data}'")
                                            used_range.value = new_data
                                            file_modified = True
                    except Exception as e:
                        log(f"âš ï¸ å•å…ƒæ ¼å¤„ç†å¼‚å¸¸: {str(e)[:50]}")

                    # é¡µçœ‰é¡µè„šå¤„ç†
                    try:
                        ps = sheet.api.PageSetup
                        for attr in ["LeftHeader", "CenterHeader", "RightHeader",
                                     "LeftFooter", "CenterFooter", "RightFooter"]:
                            val = getattr(ps, attr)
                            if val:
                                for old, new in zip(old_texts, new_texts):
                                    if old and old in val:
                                        new_val = val.replace(old, new)
                                        setattr(ps, attr, new_val)
                                        file_modified = True
                                        log(f"  ğŸ”„ {sheet.name} {attr} : '{val}' â†’ '{new_val}'")
                    except Exception as e:
                        log(f"âš ï¸ é¡µçœ‰é¡µè„šå¤„ç†å¼‚å¸¸: {str(e)[:50]}")

                if file_modified:
                    wb.save()
                    log(f"  ğŸ’¾ å·²ä¿å­˜: {os.path.basename(file_path)}")
                else:
                    log(f"  â­ï¸ æœªä¿®æ”¹: {os.path.basename(file_path)}")
            except Exception as e:
                log(f"âŒ æ–‡ä»¶å¤„ç†å¤±è´¥: {os.path.basename(file_path)}\n    {str(e)[:100]}")
            finally:
                if wb:
                    wb.close()
                    gc.collect()

        log("ğŸ‰ Excel æ–‡ä»¶å¤„ç†å®Œæˆï¼")
    except Exception as e:
        log(f"âŒ Excel è‡´å‘½é”™è¯¯: {str(e)}")
    finally:
        if app:
            app.quit()
            gc.collect()
            log("âœ… Excel èµ„æºå·²é‡Šæ”¾")


# ----------------- CAD æ›¿æ¢å‡½æ•°ï¼ˆå¢å¼ºç¨³å®šç‰ˆï¼‰ -----------------
def replace_text_in_dwg(dwg_path, old_texts, new_texts, acad):
    try:
        log(f"\nâ¡ï¸ å¤„ç†æ–‡ä»¶: {dwg_path}")

        # æ‰“å¼€æ–‡ä»¶
        doc = acad.Documents.Open(dwg_path)

        # è®¡ç®—åŠ¨æ€å»¶æ—¶ï¼ˆå¤§æ–‡ä»¶ç­‰å¾…æ›´ä¹…ï¼‰
        file_size_mb = os.path.getsize(dwg_path) / (1024 * 1024)
        delay_time = 1 + min(file_size_mb / 5, 3)
        time.sleep(delay_time)

        # å°è¯•å¼ºåˆ¶åˆ·æ–°è§†å›¾ï¼ˆå¸®åŠ©åŠ è½½å¤§å‹æ–‡ä»¶ï¼‰
        try:
            doc.Application.ZoomExtents()
            time.sleep(0.5)
        except:
            pass

        try:
            ms = doc.ModelSpace
        except Exception:
            log("  âŒ æ–‡ä»¶æ²¡æœ‰ ModelSpaceï¼Œå¯èƒ½æŸåæˆ–éæ ‡å‡† DWGã€‚")
            doc.Close(False)
            return

        changed = 0
        for entity in ms:
            try:
                if entity.ObjectName in ["AcDbText", "AcDbMText"]:
                    for old, new in zip(old_texts, new_texts):
                        if old and old in entity.TextString:
                            entity.TextString = entity.TextString.replace(old, new)
                            changed += 1
                            log(f"  ğŸ”„ {entity.ObjectName} æ›¿æ¢: {old} -> {new}")

                elif entity.ObjectName == "AcDbBlockReference" and entity.HasAttributes:
                    for attr in entity.GetAttributes():
                        for old, new in zip(old_texts, new_texts):
                            if old and old in attr.TextString:
                                attr.TextString = attr.TextString.replace(old, new)
                                attr.Update()
                                changed += 1
                                log(f"  ğŸ”„ å—å±æ€§æ–‡å­—æ›¿æ¢å®Œæˆ: {old} -> {new}")
            except Exception as e_entity:
                log(f"    âš ï¸ å®ä½“å¤„ç†å¼‚å¸¸: {e_entity}")

        # å†ç­‰å¾…ä¸€ç‚¹ï¼Œç¡®ä¿å±æ€§æ›´æ–°å®Œæˆ
        time.sleep(0.5)

        if changed > 0:
            doc.Save()
            log(f"  âœ… ä¿å­˜æˆåŠŸï¼Œå…±æ›¿æ¢ {changed} é¡¹ã€‚")
        else:
            log("  âš ï¸ æœªæ‰¾åˆ°åŒ¹é…é¡¹ã€‚")

        doc.Close(False)
        gc.collect()
        time.sleep(0.2)

    except Exception as e:
        log(f"âŒ é”™è¯¯å¤„ç†æ–‡ä»¶ {dwg_path}: {e}")


def replace_cad_text(folder, old_texts, new_texts):
    dwg_files = [os.path.join(folder, f) for f in os.listdir(folder)
                 if f.lower().endswith(".dwg") and not f.startswith("~$")]
    if not dwg_files:
        log("âš ï¸ æœªæ‰¾åˆ° DWG æ–‡ä»¶")
        return

    try:
        log("ğŸš€ å¯åŠ¨ AutoCAD ä¸­...")
        acad = win32com.client.Dispatch("AutoCAD.Application")
        acad.Visible = False
        time.sleep(2)

        for dwg_path in dwg_files:
            replace_text_in_dwg(dwg_path, old_texts, new_texts, acad)

        log(f"\nâœ… æ‰€æœ‰ DWG æ–‡ä»¶å¤„ç†å®Œæˆï¼Œå…±å¤„ç† {len(dwg_files)} ä¸ªæ–‡ä»¶ã€‚")
    except Exception as e:
        log(f"âŒ AutoCAD å¯åŠ¨å¤±è´¥: {str(e)}")


# ----------------- å¯åŠ¨æ›¿æ¢çº¿ç¨‹ -----------------
def start_replacement():
    folder = folder_entry.get()
    old_texts = [e.get() for e in old_entries]
    new_texts = [e.get() for e in new_entries]

    log_text.delete(1.0, tk.END)

    if not folder or not os.path.isdir(folder):
        messagebox.showerror("é”™è¯¯", "è¯·é€‰æ‹©æœ‰æ•ˆçš„æ–‡ä»¶å¤¹")
        return
    if not any(old_texts) or not any(new_texts):
        messagebox.showerror("é”™è¯¯", "è¯·è¾“å…¥è‡³å°‘ä¸€å¯¹æ›¿æ¢æ–‡å­—")
        return

    def task():
        if excel_var.get():
            replace_excel_text(folder, old_texts, new_texts)
        if cad_var.get():
            replace_cad_text(folder, old_texts, new_texts)

    threading.Thread(target=task, daemon=True).start()


# ----------------- GUI ç•Œé¢ -----------------
root = tk.Tk()
root.title("æ‰¹é‡æ›¿æ¢ Excel å’Œ CAD æ–‡ä»¶æ–‡å­—")
root.geometry("800x700")
root.resizable(False, False)

# æ–‡ä»¶å¤¹é€‰æ‹©
tk.Label(root, text="é€‰æ‹©æ–‡ä»¶å¤¹ï¼š").grid(row=0, column=0, sticky="e", padx=10, pady=10)
folder_entry = tk.Entry(root, width=72)
folder_entry.grid(row=0, column=1, padx=5)


def select_folder():
    folder = filedialog.askdirectory()
    if folder:
        folder_entry.delete(0, tk.END)
        folder_entry.insert(0, folder)


tk.Button(root, text="æµè§ˆ...", command=select_folder).grid(row=0, column=2, padx=5)

# æ›¿æ¢æ–‡å­—è¾“å…¥
old_entries, new_entries = [], []
frame = tk.LabelFrame(root, text="æ‰¹é‡æ›¿æ¢æ–‡å­—ï¼ˆæœ€å¤š5ç»„ï¼‰", padx=10, pady=10)
frame.grid(row=1, column=0, columnspan=3, padx=10, pady=10, sticky="ew")

for i in range(5):
    row_index = i * 2
    tk.Label(frame, text=f"æ—§æ–‡å­— {i+1}:").grid(row=row_index, column=0, sticky="e", pady=4)
    old_entry = tk.Entry(frame, width=40)
    old_entry.grid(row=row_index, column=1, pady=4, padx=(0, 50))
    old_entries.append(old_entry)

    tk.Label(frame, text=f"æ–°æ–‡å­— {i+1}:").grid(row=row_index, column=2, sticky="e", pady=4)
    new_entry = tk.Entry(frame, width=40)
    new_entry.grid(row=row_index, column=3, pady=4, padx=5)
    new_entries.append(new_entry)

    if i < 4:
        ttk.Separator(frame, orient='horizontal').grid(row=row_index+1, column=0, columnspan=4, sticky="ew", pady=5)

# å‹¾é€‰æ¡†
excel_var = tk.BooleanVar(value=True)
cad_var = tk.BooleanVar(value=True)
tk.Checkbutton(root, text="å¤„ç† Excel æ–‡ä»¶", variable=excel_var).grid(row=2, column=1, sticky="w", padx=20)
tk.Checkbutton(root, text="å¤„ç† CAD æ–‡ä»¶", variable=cad_var).grid(row=2, column=1, sticky="e", padx=20)

# å¼€å§‹æŒ‰é’®
tk.Button(root, text="å¼€å§‹æ›¿æ¢", width=20, height=2, bg="#4CAF50", fg="white", command=start_replacement).grid(row=3, column=1, pady=15)

# æ—¥å¿—æ¡†
log_text = scrolledtext.ScrolledText(root, width=107, height=20)
log_text.grid(row=4, column=0, columnspan=3, padx=10, pady=10)

# é‡å®šå‘ stdout/stderr
sys.stdout = RedirectText(log_text)
sys.stderr = RedirectText(log_text)

root.mainloop()


