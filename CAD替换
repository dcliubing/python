import win32com.client
import os
import time
import tkinter as tk
from tkinter import filedialog, messagebox, scrolledtext
import sys

# ------------------ æ—¥å¿—é‡å®šå‘ ------------------
class RedirectText:
    def __init__(self, text_widget):
        self.output = text_widget

    def write(self, string):
        self.output.insert(tk.END, string)
        self.output.see(tk.END)
        self.output.update()  # å®æ—¶åˆ·æ–°æ—¥å¿—

    def flush(self):
        pass

# ------------------ DWG æ›¿æ¢å‡½æ•° ------------------
def replace_text_in_dwg(dwg_path, old_text, new_text, acad):
    try:
        print(f"\nâ¡ï¸ å¤„ç†æ–‡ä»¶: {dwg_path}")
        doc = acad.Documents.Open(dwg_path)
        time.sleep(0.5)

        try:
            ms = doc.ModelSpace
        except Exception:
            print("  âŒ æ–‡ä»¶æ²¡æœ‰ ModelSpaceï¼Œå¯èƒ½æŸåæˆ–éæ ‡å‡† DWGã€‚")
            doc.Close(False)
            return

        changed = 0

        for entity in ms:
            try:
                # æ›¿æ¢ TEXT
                if entity.ObjectName == "AcDbText" and old_text in entity.TextString:
                    entity.TextString = entity.TextString.replace(old_text, new_text)
                    print(f"  ğŸ”„ TEXT æ›¿æ¢: {old_text} -> {new_text}")
                    changed += 1

                # æ›¿æ¢ MTEXT
                elif entity.ObjectName == "AcDbMText" and old_text in entity.TextString:
                    entity.TextString = entity.TextString.replace(old_text, new_text)
                    print(f"  ğŸ”„ MTEXT æ›¿æ¢: {old_text} -> {new_text}")
                    changed += 1

                # æ›¿æ¢å—å±æ€§
                elif entity.ObjectName == "AcDbBlockReference":
                    if entity.HasAttributes:
                        for attr in entity.GetAttributes():
                            if old_text in attr.TextString:
                                attr.TextString = attr.TextString.replace(old_text, new_text)
                                # ä¿æŒå—å±æ€§å¯è§
                                attr.Update()
                                changed += 1
                                # ä¸æ‰“å°å±æ€§åç§°ï¼Œåªæ‰“å°æ›¿æ¢ç»“æœ
                                print(f"  ğŸ”„ å—å±æ€§æ–‡å­—æ›¿æ¢å®Œæˆ")
            except Exception as e_entity:
                print(f"    âš ï¸ å®ä½“å¤„ç†å¼‚å¸¸: {e_entity}")

        if changed > 0:
            doc.Save()
            print(f"  âœ… ä¿å­˜æˆåŠŸï¼Œå…±æ›¿æ¢ {changed} é¡¹ã€‚")
        else:
            print("  âš ï¸ æœªæ‰¾åˆ°åŒ¹é…é¡¹ã€‚")

        doc.Close(False)

    except Exception as e:
        print(f"âŒ é”™è¯¯å¤„ç†æ–‡ä»¶ {dwg_path}: {e}")

# ------------------ Tkinter ç•Œé¢ ------------------
def browse_folder():
    folder = filedialog.askdirectory(title="é€‰æ‹©åŒ…å« DWG æ–‡ä»¶çš„æ–‡ä»¶å¤¹")
    if folder:
        folder_entry.delete(0, tk.END)
        folder_entry.insert(0, folder)

def start_replacement():
    folder = folder_entry.get()
    old_text = old_text_entry.get()
    new_text = new_text_entry.get()
    log_text.delete(1.0, tk.END)

    if not folder or not os.path.isdir(folder):
        messagebox.showerror("é”™è¯¯", "è¯·é€‰æ‹©æœ‰æ•ˆçš„æ–‡ä»¶å¤¹")
        return
    if not old_text:
        messagebox.showerror("é”™è¯¯", "è¯·è¾“å…¥è¦æ›¿æ¢çš„æ—§æ–‡å­—")
        return

    dwg_files = [os.path.join(folder, f) for f in os.listdir(folder) if f.lower().endswith(".dwg")]
    if not dwg_files:
        messagebox.showwarning("æœªæ‰¾åˆ°æ–‡ä»¶", "æ‰€é€‰ç›®å½•ä¸­æœªæ‰¾åˆ° DWG æ–‡ä»¶")
        return

    try:
        print("ğŸš€ å¯åŠ¨ AutoCAD ä¸­...")
        acad = win32com.client.Dispatch("AutoCAD.Application")
        acad.Visible = False
        time.sleep(1)

        for dwg_path in dwg_files:
            replace_text_in_dwg(dwg_path, old_text, new_text, acad)

        print(f"\nâœ… æ‰€æœ‰ DWG æ–‡ä»¶å¤„ç†å®Œæˆï¼Œå…±å¤„ç† {len(dwg_files)} ä¸ªæ–‡ä»¶ã€‚")
        messagebox.showinfo("å®Œæˆ", f"æ‰€æœ‰ DWG æ–‡ä»¶å¤„ç†å®Œæˆï¼å…±å¤„ç† {len(dwg_files)} ä¸ªæ–‡ä»¶ã€‚")

    except Exception as e:
        messagebox.showerror("AutoCAD å¯åŠ¨å¤±è´¥", str(e))

# ------------------ ç•Œé¢å¸ƒå±€ ------------------
root = tk.Tk()
root.title("æ‰¹é‡æ›¿æ¢ DWG æ–‡ä»¶æ–‡å­—")
root.geometry("700x500")
root.resizable(False, False)

tk.Label(root, text="é€‰æ‹© DWG æ–‡ä»¶å¤¹ï¼š").grid(row=0, column=0, sticky="e", padx=10, pady=10)
folder_entry = tk.Entry(root, width=50)
folder_entry.grid(row=0, column=1, padx=5)
tk.Button(root, text="æµè§ˆ...", command=browse_folder).grid(row=0, column=2, padx=5)

tk.Label(root, text="è¦æ›¿æ¢çš„æ—§æ–‡å­—ï¼š").grid(row=1, column=0, sticky="e", padx=10, pady=10)
old_text_entry = tk.Entry(root, width=50)
old_text_entry.grid(row=1, column=1, columnspan=2, padx=5)

tk.Label(root, text="æ›¿æ¢ä¸ºçš„æ–°æ–‡å­—ï¼š").grid(row=2, column=0, sticky="e", padx=10, pady=10)
new_text_entry = tk.Entry(root, width=50)
new_text_entry.grid(row=2, column=1, columnspan=2, padx=5)

tk.Button(root, text="å¼€å§‹æ›¿æ¢", width=20, height=2, bg="#4CAF50", fg="white", command=start_replacement)\
    .grid(row=3, column=1, pady=15)

log_text = scrolledtext.ScrolledText(root, width=85, height=15)
log_text.grid(row=4, column=0, columnspan=3, padx=10, pady=10)

sys.stdout = RedirectText(log_text)
sys.stderr = RedirectText(log_text)

root.mainloop()
