import os
import threading
import gc
import tkinter as tk
from tkinter import filedialog, scrolledtext
import win32com.client as win32

def log(message):
    """åœ¨æ—¥å¿—çª—å£æ˜¾ç¤ºæ¶ˆæ¯"""
    log_text.insert(tk.END, message + "\n")
    log_text.yview(tk.END)

def select_folder():
    """é€‰æ‹© Excel æ–‡ä»¶æ‰€åœ¨çš„æ–‡ä»¶å¤¹"""
    folder_selected = filedialog.askdirectory()
    if folder_selected:
        folder_entry.delete(0, tk.END)
        folder_entry.insert(0, folder_selected)

def start_replacement():
    """ä½¿ç”¨å¤šçº¿ç¨‹å¯åŠ¨ Excel æ›¿æ¢ä»»åŠ¡ï¼Œé˜²æ­¢ GUI å¡æ­»"""
    threading.Thread(target=replace_excel_text, daemon=True).start()

def replace_excel_text():
    """éå† Excel æ–‡ä»¶å¹¶æ›¿æ¢æ–‡æœ¬"""
    folder_path = folder_entry.get()
    old_text = old_text_entry.get()
    new_text = new_text_entry.get()

    if not folder_path:
        log("âŒ æœªé€‰æ‹©ç›®å½•ï¼Œé€€å‡ºç¨‹åºã€‚")
        return
    if not old_text or not new_text:
        log("âŒ æœªè¾“å…¥æ›¿æ¢æ–‡æœ¬ï¼Œé€€å‡ºç¨‹åºã€‚")
        return

    log("âœ… å¼€å§‹å¤„ç† Excel æ–‡ä»¶...")
    
    try:
        # å¯åŠ¨ Excel
        excel = win32.Dispatch('Excel.Application')
        excel.ScreenUpdating = False  # ç¦ç”¨å±å¹•åˆ·æ–°ï¼ŒåŠ å¿«é€Ÿåº¦
        excel.DisplayAlerts = False  # ç¦ç”¨è­¦å‘Šå¼¹çª—

        # æŸ¥æ‰¾æ‰€æœ‰ Excel æ–‡ä»¶
        files = [os.path.join(root, f) for root, _, filenames in os.walk(folder_path) for f in filenames if f.endswith((".xls", ".xlsx"))]

        for file_path in files:
            log(f"ğŸ”„ å¤„ç†ä¸­ï¼š{file_path}")
            try:
                workbook = excel.Workbooks.Open(file_path)
                file_modified = False

                for sheet in workbook.Sheets:
                    if not sheet.Visible:  # è·³è¿‡éšè—çš„ Sheet
                        continue

                    used_range = sheet.UsedRange
                    data = used_range.Value  # è·å–æ•´ä¸ªè¡¨æ ¼æ•°æ®

                    if data:
                        updated = False  # è®°å½•æ˜¯å¦ä¿®æ”¹
                        new_data = []  # å­˜å‚¨æ–°æ•°æ®

                        for row in data:
                            if isinstance(row, tuple):  # å¤šè¡Œæ•°æ®
                                new_row = list(row)  # è½¬æ¢ä¸ºåˆ—è¡¨
                                for col_idx, cell in enumerate(new_row):
                                    if isinstance(cell, str) and old_text in cell:
                                        new_row[col_idx] = cell.replace(old_text, new_text)
                                        updated = True
                                new_data.append(tuple(new_row))  # è½¬æ¢å›å…ƒç»„
                            else:  # å•è¡Œæ•°æ®
                                if isinstance(row, str) and old_text in row:
                                    row = row.replace(old_text, new_text)
                                    updated = True
                                new_data.append(row)

                        if updated:
                            used_range.Value = new_data  # æ‰¹é‡å†™å› Excel
                            file_modified = True

                if file_modified:
                    workbook.Save()
                    log(f"âœ… å·²ä¿®æ”¹å¹¶ä¿å­˜ï¼š{file_path}")
                workbook.Close(SaveChanges=True)
            except Exception as e:
                log(f"âŒ å¤„ç†é”™è¯¯ {file_path}: {e}")

        # å…³é—­ Excel
        excel.Quit()
        del excel
        gc.collect()  # å›æ”¶èµ„æº
        log("ğŸ‰ æ‰€æœ‰ Excel å¤„ç†å®Œæˆï¼")

    except Exception as e:
        log(f"âŒ Excel å¤„ç†å¤±è´¥ï¼š{e}")

# åˆ›å»º GUI ç•Œé¢
root = tk.Tk()
root.title("Excel æ–‡æœ¬æ‰¹é‡æ›¿æ¢å·¥å…·")
root.geometry("600x400")

# é€‰æ‹©æ–‡ä»¶å¤¹
tk.Label(root, text="é€‰æ‹©æ–‡ä»¶å¤¹:").pack()
folder_frame = tk.Frame(root)
folder_frame.pack(fill="x", padx=10)
folder_entry = tk.Entry(folder_frame, width=50)
folder_entry.pack(side="left", fill="x", expand=True)
tk.Button(folder_frame, text="æµè§ˆ", command=select_folder).pack(side="right")

# æ—§æ–‡æœ¬è¾“å…¥æ¡†
tk.Label(root, text="åŸæ–‡æœ¬:").pack()
old_text_entry = tk.Entry(root, width=50)
old_text_entry.pack()

# æ–°æ–‡æœ¬è¾“å…¥æ¡†
tk.Label(root, text="æ›¿æ¢ä¸º:").pack()
new_text_entry = tk.Entry(root, width=50)
new_text_entry.pack()

# æ‰§è¡ŒæŒ‰é’®
tk.Button(root, text="å¼€å§‹æ›¿æ¢", command=start_replacement, bg="green", fg="white").pack(pady=10)

# æ—¥å¿—è¾“å‡ºæ¡†
log_text = scrolledtext.ScrolledText(root, width=70, height=10)
log_text.pack(padx=10, pady=10)

# è¿è¡Œ GUI
root.mainloop()
