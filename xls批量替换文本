import os
import threading
import gc
import tkinter as tk
from tkinter import filedialog, scrolledtext, messagebox
import win32com.client as win32
from tkinter import ttk

def log(message):
    log_text.insert(tk.END, message + "\n")
    log_text.yview(tk.END)

def select_folder():
    folder_selected = filedialog.askdirectory()
    if folder_selected:
        folder_entry.delete(0, tk.END)
        folder_entry.insert(0, folder_selected)

def start_replacement():
    threading.Thread(target=replace_excel_text, daemon=True).start()

def replace_excel_text():
    folder_path = folder_entry.get()
    old_text = old_text_entry.get()
    new_text = new_text_entry.get()

    if not folder_path:
        log("âŒ æœªé€‰æ‹©ç›®å½•ï¼Œé€€å‡ºç¨‹åºã€‚")
        return
    if not old_text or not new_text:
        log("âŒ æœªè¾“å…¥æ›¿æ¢æ–‡æœ¬ï¼Œé€€å‡ºç¨‹åºã€‚")
        return

    log("âœ… å¼€å§‹å¤„ç† Excel æ–‡ä»¶...")
    excel = None  # å£°æ˜åœ¨å¤–éƒ¨ä»¥ä¾¿finallyè®¿é—®

    try:
        # åˆ›å»ºå…¨æ–°çš„ç‹¬ç«‹Excelè¿›ç¨‹ï¼ˆå…³é”®ä¿®æ”¹ï¼‰
        excel = win32.DispatchEx("Excel.Application")
        log("âœ… å·²åˆ›å»ºå®Œå…¨ç‹¬ç«‹çš„ Excel å®ä¾‹ï¼ˆè¿›ç¨‹éš”ç¦»ï¼‰")

        excel.Visible = False
        excel.ScreenUpdating = False
        excel.DisplayAlerts = False

        files = [os.path.join(root, f) for root, _, filenames in os.walk(folder_path)
                 for f in filenames if f.endswith((".xls", ".xlsx"))]

        for file_path in files:
            log(f"ğŸ”„ å¤„ç†ä¸­ï¼š{file_path}")
            workbook = None
            try:
                # æ‰“å¼€æ–‡ä»¶
                workbook = excel.Workbooks.Open(file_path)
                file_modified = False

                # å¤„ç†æ¯ä¸ªå·¥ä½œè¡¨
                for sheet in workbook.Sheets:
                    if not sheet.Visible:
                        continue

                    # æ›¿æ¢å•å…ƒæ ¼å†…å®¹
                    try:
                        used_range = sheet.UsedRange
                        data = used_range.Value

                        if data:
                            updated = False
                            new_data = []
                            for row in data:
                                if isinstance(row, tuple):
                                    new_row = list(row)
                                    for col_idx, cell in enumerate(new_row):
                                        if isinstance(cell, str) and old_text in cell:
                                            new_row[col_idx] = cell.replace(old_text, new_text)
                                            updated = True
                                    new_data.append(tuple(new_row))
                                else:
                                    if isinstance(row, str) and old_text in row:
                                        row = row.replace(old_text, new_text)
                                        updated = True
                                    new_data.append(row)
                            if updated:
                                used_range.Value = new_data
                                file_modified = True
                    except Exception as e:
                        log(f"âš ï¸ å•å…ƒæ ¼å¤„ç†å¼‚å¸¸: {str(e)[:50]}")

                    # æ›¿æ¢é¡µçœ‰é¡µè„š
                    try:
                        for attr in ["LeftHeader", "CenterHeader", "RightHeader",
                                    "LeftFooter", "CenterFooter", "RightFooter"]:
                            val = getattr(sheet.PageSetup, attr)
                            if old_text in val:
                                setattr(sheet.PageSetup, attr, val.replace(old_text, new_text))
                                file_modified = True
                    except Exception as e:
                        log(f"âš ï¸ é¡µçœ‰é¡µè„šå¤„ç†å¼‚å¸¸: {str(e)[:50]}")

                # ä¿å­˜ä¿®æ”¹
                if file_modified:
                    workbook.Save()
                    log(f"ğŸ’¾ å·²ä¿å­˜: {os.path.basename(file_path)}")
                else:
                    log(f"â­ï¸ æœªä¿®æ”¹: {os.path.basename(file_path)}")

            except Exception as e:
                log(f"âŒ æ–‡ä»¶å¤„ç†å¤±è´¥: {os.path.basename(file_path)}\n    {str(e)[:100]}")
            finally:
                # ç¡®ä¿å…³é—­å·¥ä½œç°¿
                if workbook:
                    workbook.Close(SaveChanges=False)
                    del workbook
                    gc.collect()

        log("ğŸ‰ æ‰€æœ‰æ–‡ä»¶å¤„ç†å®Œæˆï¼")

    except Exception as e:
        log(f"âŒ è‡´å‘½é”™è¯¯: {str(e)}")
    finally:
        # å®‰å…¨é‡Šæ”¾èµ„æºï¼ˆå…³é”®ä¿®æ”¹ï¼‰
        if excel:
            log("ğŸ”’ æ­£åœ¨å®‰å…¨é‡Šæ”¾èµ„æº...")
            try:
                # å…³é—­æ‰€æœ‰æ®‹ç•™å·¥ä½œç°¿
                while excel.Workbooks.Count > 0:
                    wb = excel.Workbooks[0]
                    wb.Close(SaveChanges=False)
                    del wb
                # ä¸è°ƒç”¨Quit()ï¼Œé¿å…å½±å“å…¶ä»–å®ä¾‹
                del excel
                gc.collect()
                log("âœ… èµ„æºå·²å®Œå…¨é‡Šæ”¾")
            except Exception as e:
                log(f"âš ï¸ èµ„æºé‡Šæ”¾å¼‚å¸¸: {str(e)[:50]}")

# ----------------- GUI ç•Œé¢ --------------------
root = tk.Tk()
root.title("Excel æ–‡æœ¬æ‰¹é‡æ›¿æ¢å·¥å…· ï¼ˆï¼‰")
root.geometry("680x500")

style = ttk.Style()
style.configure("TNotebook", tabposition="nw")
style.configure("TFrame", background="#f0f0f0")

notebook = ttk.Notebook(root)
notebook.pack(fill="both", expand=True, padx=10, pady=10)

# ä¸»ç•Œé¢
frame_main = ttk.Frame(notebook)
notebook.add(frame_main, text="ä¸»ç•Œé¢")

tk.Label(frame_main, text="é€‰æ‹©æ–‡ä»¶å¤¹:", font=("å¾®è½¯é›…é»‘", 10)).pack(pady=5)
folder_frame = ttk.Frame(frame_main)
folder_frame.pack(fill="x", padx=20)
folder_entry = ttk.Entry(folder_frame, width=50)
folder_entry.pack(side="left", fill="x", expand=True)
ttk.Button(folder_frame, text="æµè§ˆ", command=select_folder).pack(side="right")

ttk.Label(frame_main, text="åŸæ–‡æœ¬:", font=("å¾®è½¯é›…é»‘", 10)).pack(pady=5)
old_text_entry = ttk.Entry(frame_main, width=50)
old_text_entry.pack()

ttk.Label(frame_main, text="æ›¿æ¢ä¸º:", font=("å¾®è½¯é›…é»‘", 10)).pack(pady=5)
new_text_entry = ttk.Entry(frame_main, width=50)
new_text_entry.pack()

ttk.Button(frame_main, text="å¼€å§‹æ›¿æ¢", command=start_replacement, style="Accent.TButton").pack(pady=15)

# æ—¥å¿—åŒºåŸŸ
log_frame = ttk.Frame(frame_main)
log_frame.pack(fill="both", expand=True, padx=10, pady=5)
log_text = scrolledtext.ScrolledText(log_frame, width=85, height=15, font=("Consolas", 9))
log_text.pack(fill="both", expand=True)

# å…³äºç•Œé¢
frame_about = ttk.Frame(notebook)
notebook.add(frame_about, text="å…³äº")
about_text = """ Excel æ‰¹é‡æ›¿æ¢å·¥å…· 

 : )


"""
ttk.Label(frame_about, text=about_text, font=("å¾®è½¯é›…é»‘", 11), justify="left").pack(padx=30, pady=30, anchor="w")

root.mainloop()
